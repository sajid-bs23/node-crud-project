# SonarQube Coverage Report Setup

## Current Configuration

The project is configured to generate LCOV format coverage reports that SonarQube can read.

## Coverage Report Location

- **LCOV Report**: `coverage/lcov.info` (SonarQube compatible format)
- **JSON Summary**: `coverage/coverage-summary.json`
- **HTML Report**: `coverage/index.html` (in `coverage/lcov-report/` directory)

## Generating Coverage Report

```bash
make coverage
# or
npm run coverage
```

This will generate the coverage report in the `coverage/` directory.

## SonarQube Configuration

The `sonar-project.properties` file contains:

```properties
sonar.javascript.lcov.reportPaths=coverage/lcov.info
```

## Troubleshooting Coverage Upload Issues

### 1. Verify Coverage File Exists

```bash
ls -la coverage/lcov.info
```

The file should exist and have content (typically 200+ lines).

### 2. Check File Path

The path in `sonar-project.properties` is relative to the project root. Ensure:
- You're running SonarQube scanner from the project root directory
- The path `coverage/lcov.info` is correct relative to where you run the scanner

### 3. Alternative Property Names

If `sonar.javascript.lcov.reportPaths` doesn't work, try these alternatives depending on your SonarQube version:

**For SonarQube 7.9+ (JavaScript/TypeScript plugin):**
```properties
sonar.javascript.lcov.reportPaths=coverage/lcov.info
```

**Alternative (if above doesn't work):**
```properties
sonar.coverage.jacoco.xmlReportPaths=coverage/lcov.info
```

**Or try without the language prefix:**
```properties
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.coverage.exclusions=**/node_modules/**,**/coverage/**
```

### 4. Verify SonarQube Scanner Command

When running SonarQube scanner, ensure you're in the project root:

```bash
cd /home/bs01411/BrainStation23/QMS/node-crud-project
sonar-scanner
# or
sonar-scanner -Dsonar.projectKey=bs23:qms:node-crud-project
```

### 5. Check SonarQube Logs

If coverage still doesn't upload, check the SonarQube scanner logs for errors related to:
- File not found
- Invalid format
- Permission issues

### 6. Manual Verification

Verify the LCOV file format is correct:

```bash
head -20 coverage/lcov.info
```

You should see:
```
TN:
SF:src/models/Book.js
...
```

### 7. Ensure Tests Pass

The coverage report is only generated if tests complete (even if some fail). Ensure all tests pass:

```bash
npm test
```

## Common Issues

1. **File not found**: Ensure `make coverage` or `npm run coverage` is run before SonarQube analysis
2. **Wrong path**: Verify the path in `sonar-project.properties` matches the actual file location
3. **Permission issues**: Ensure SonarQube scanner has read access to `coverage/lcov.info`
4. **Format issues**: The LCOV format should be generated by Jest automatically

## Verification Steps

1. Generate coverage: `make coverage`
2. Verify file exists: `test -f coverage/lcov.info && echo "File exists"`
3. Check file size: `wc -l coverage/lcov.info` (should be 200+ lines)
4. Run SonarQube scanner from project root
5. Check SonarQube dashboard for coverage metrics

